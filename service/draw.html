<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Drawing Board ‚Äì Full Controls</title>
<!-- Corrected Font Awesome CDN link to version 6.0.0-beta3 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  :root {
    --panel-width: 10vw;
    --panel-width-mobile: 15vw;
    --panel-bg: #1f2937; /* Dark background for the panel */
    --panel-fg: #e5e7eb; /* Light foreground for text/icons on panel */
    --accent: #3b82f6; /* Blue accent color */
    --gap: 0.75rem;
    --btn-size: 48px;
    --font-size: 28px;
  }
  html, body {
    margin: 0; padding: 0; background: #ccc; height: 100%; overflow: hidden;
    font-family: system-ui, sans-serif;
  }
  #board, #overlay {
    position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; touch-action: none;
  }
  #overlay { pointer-events: none; }
  #penCursor {
    position: absolute;
    pointer-events: none; /* Important: allows drawing events to pass through */
    z-index: 200; /* Ensure it's above canvas */
    display: none; /* Hidden by default */
    /* Color will be set dynamically by JavaScript */
    font-size: var(--font-size); /* Use the defined font size */
    text-shadow: 0 0 2px rgba(0,0,0,0.5); /* Subtle shadow for better contrast */
    /* Adjust transform to position the tip at the cursor */
    transform: translate(-10%, -90%); /* Fine-tuned for fa-pencil-alt */
  }
  #eraserCursor {
    position: absolute; border: 2px solid #ff4d4d; border-radius: 50%; pointer-events: none; display: none; box-sizing: border-box; background: transparent;
  }
  #toggleControls {
    position: fixed; top: 0.5rem; right: 0.5rem;
    width: var(--btn-size); height: var(--btn-size);
    border: none; border-radius: 0.35rem; cursor: pointer;
    background: var(--panel-bg); color: var(--panel-fg);
    font-size: 24px; z-index: 10; display: grid; place-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,.4);
  }
  #controls {
    position: fixed; top: calc(var(--btn-size) + 1rem); right: 0.5rem;
    width: var(--panel-width);
    background: var(--panel-bg); color: var(--panel-fg);
    box-sizing: border-box; padding: 1rem;
    display: none; flex-direction: column; gap: var(--gap);
    border-radius: 0.4rem; box-shadow: 0 4px 16px rgba(0,0,0,.35);
    max-height: calc(100vh - var(--btn-size) - 2rem);
    overflow-y: auto;
  }
  .section { display: flex; flex-direction: column; gap: 0.5rem; }

  /* Base button styling for all tool, action, and shape buttons */
  button.tool, button.action, button.shape-dropdown-trigger, button.shape-dropdown-item {
    background-color: #374151; /* A solid dark gray background */
    border: 1px solid transparent; /* No visible border by default */
    border-radius: 0.5rem;
    padding: 0.5rem;
    cursor: pointer;
    /* color will be set dynamically for pen/shapes, default white for others */
    color: #ffffff; /* Default white icon/text color for action buttons and unselected shapes */
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--btn-size);
    font-size: var(--font-size);
    user-select: none;
    transition: background-color 0.2s, border-color 0.2s;
  }
  button.tool:hover, button.action:hover, button.shape-dropdown-trigger:hover, button.shape-dropdown-item:hover {
    background-color: #4b5563; /* Slightly lighter gray on hover */
  }

  /* Active state for tools and shape items */
  button.tool.active, button.shape-dropdown-trigger.active, button.shape-dropdown-item.active {
    border-color: var(--accent); /* Blue border for active */
    background-color: rgba(59,130,246,0.25); /* Lighter blue background for active */
  }

  /* Pen icon styling (for the button) */
  .pen-icon { filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); /* Subtle shadow for better contrast */ }
  .color-control {
    display: flex; align-items: center; gap: 0.25rem;
  }
  .color-control label { font-size: 20px; }
  input[type="color"], input[type="range"] {
    height: 36px; border-radius: 0.35rem; background: rgba(255,255,255,0.06);
    border: none; color: inherit; padding: 0 0.5rem; margin-top: 0.25rem;
  }
  @media (max-width: 768px) {
    :root { --panel-width: var(--panel-width-mobile); --btn-size: 56px; --font-size: 32px; --gap: 1rem; }
    input[type="color"], input[type="range"] { height: 44px; }
    #controls { right: 0.25rem; padding: 0.75rem; }
  }

  /* Custom Shape Selector Styles */
  .shape-selector {
    position: relative;
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .shape-dropdown-trigger {
    width: var(--btn-size); /* Make it square like other buttons */
  }

  .shape-dropdown-menu {
    position: absolute;
    top: calc(var(--btn-size) + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel-bg);
    border-radius: 0.4rem;
    box-shadow: 0 4px 16px rgba(0,0,0,.35);
    display: none;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.5rem;
    z-index: 101;
  }
  .shape-dropdown-menu.open {
    display: flex;
  }

  .shape-dropdown-item {
    width: var(--btn-size); /* Make it square */
  }

  /* Explicit styling for Font Awesome icons within buttons */
  button.tool i, button.action i, button.shape-dropdown-trigger i, button.shape-dropdown-item i, #penCursor {
    font-size: var(--font-size); /* Ensure font size is applied */
    text-shadow: 0 0 2px rgba(0,0,0,0.5); /* Subtle shadow for better contrast */
    font-family: "Font Awesome 6 Free"; /* Explicitly set Font Awesome font family */
    /* Removed explicit font-weight: 900; to allow Font Awesome's own CSS to handle fas/far weights */
  }

</style>
</head>
<body>
<canvas id="board"></canvas>
<canvas id="overlay"></canvas>

<!-- Pen Cursor now an i tag -->
<i id="penCursor" class="fas fa-pencil-alt"></i>
<div id="eraserCursor"></div>

<button id="toggleControls" aria-label="Toggle controls">‚ò∞</button>

<aside id="controls" aria-label="Drawing controls">
  <div class="section">
    <button class="tool active" data-tool="pen" title="Pen">
      <img class="pen-icon" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor'><path d='M2 21l1-4 12-12 4 4-12 12-4 1z'/></svg>" width="24" height="24" />
    </button>

    <div class="shape-selector">
      <button id="shapeDropdownTrigger" class="shape-dropdown-trigger active" title="Select Shape">
        <i class="fas fa-signature"></i> <!-- Changed to signature icon for curved line -->
      </button>
      <div id="shapeDropdownMenu" class="shape-dropdown-menu">
        <button class="shape-dropdown-item active" data-shape="freehand" title="Freehand"><i class="fas fa-signature"></i></button>
        <button class="shape-dropdown-item" data-shape="line" title="Line"><i class="fas fa-minus"></i></button>
        <button class="shape-dropdown-item" data-shape="rect" title="Rectangle"><i class="far fa-square"></i></button> <!-- Changed to far -->
        <button class="shape-dropdown-item" data-shape="circle" title="Circle"><i class="far fa-circle"></i></button> <!-- Changed to far -->
        <button class="shape-dropdown-item" data-shape="pentagon" title="Pentagon"><i class="far fa-star"></i></button> <!-- Changed to far -->
      </div>
    </div>

    <input id="penSize" type="range" min="1" max="10" value="3" title="Pen Size" />
    <button class="tool" data-tool="eraser" title="Eraser">ü©π</button>
    <input id="eraserSize" type="range" min="5" max="200" value="40" title="Eraser Size" />
  </div>

  <div class="section">
    <div class="color-control"><label for="penColor">üé®</label><input id="penColor" type="color" value="#000000" title="Pen color" /></div>
    <div class="color-control"><label for="bgColorPicker">üñºÔ∏è</label><input id="bgColorPicker" type="color" value="#cccccc" title="Background color" /></div>
  </div>

  <div class="section">
    <button class="action" id="undoBtn" title="Undo">‚Ü∂</button>
    <button class="action" id="clearBtn" title="Delete All">üóëÔ∏è</button>
  </div>
</aside>

<script>
(() => {
  const board = document.getElementById('board');
  const overlay = document.getElementById('overlay');
  const penCursor = document.getElementById('penCursor'); // Now an <i> element
  const eraserCursor = document.getElementById('eraserCursor');
  const toggleBtn = document.getElementById('toggleControls');
  const controls = document.getElementById('controls');

  // Get specific references for dynamic coloring
  const controlPenToolButton = document.querySelector('button.tool[data-tool="pen"]');
  const controlPenIcon = controlPenToolButton.querySelector('.pen-icon'); // The img tag for the pen icon

  let ctx = board.getContext('2d');
  let overlayCtx = overlay.getContext('2d');

  let drawing = false;
  let tool = 'pen'; // 'pen' or 'eraser'
  let penColor = '#000000';
  let bgColor = '#cccccc';
  let penSize = 3;
  let eraserSize = 40;
  let shape = 'freehand';

  let startX, startY;
  let lastX, lastY;

  let history = [];
  let historyStep = -1;

  // New elements for custom shape dropdown
  const shapeDropdownTrigger = document.getElementById('shapeDropdownTrigger');
  const shapeDropdownMenu = document.getElementById('shapeDropdownMenu');
  const shapeDropdownItems = document.querySelectorAll('.shape-dropdown-item');

  function resize() {
    let currentContentDataURL = board.toDataURL();

    board.width = window.innerWidth;
    board.height = window.innerHeight;
    overlay.width = window.innerWidth;
    overlay.height = window.innerHeight;

    if (currentContentDataURL && currentContentDataURL !== 'data:,') {
      let img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, board.width, board.height);
        ctx.drawImage(img, 0, 0, board.width, board.height);
      };
      img.src = currentContentDataURL;
    } else {
      ctx.clearRect(0, 0, board.width, board.height);
    }
  }
  window.addEventListener('resize', resize);
  resize();

  function pushHistory() {
    if(historyStep < history.length - 1) {
      history = history.slice(0, historyStep + 1);
    }
    history.push(board.toDataURL());
    historyStep++;
  }

  function undo() {
    if(historyStep > 0) {
      historyStep--;
      let img = new Image();
      img.onload = () => {
        ctx.clearRect(0, 0, board.width, board.height);
        ctx.drawImage(img, 0, 0);
      }
      img.src = history[historyStep];
    } else if(historyStep === 0) {
      ctx.clearRect(0, 0, board.width, board.height);
      historyStep = -1;
    }
  }
  // Function to clear all drawings from the canvas
  function clearAll() {
    ctx.clearRect(0, 0, board.width, board.height);
    pushHistory();
  }

  // Function to draw a freehand line on the canvas
  function drawFreehand(x1, y1, x2, y2, color, size) {
    ctx.strokeStyle = color;
    ctx.lineWidth = size;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }

  // Function to draw a line on the canvas
  function drawLine(x1, y1, x2, y2, color, size) {
    ctx.strokeStyle = color;
    ctx.lineWidth = size;
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke(); // Draws an outline
  }

  // Function to draw a rectangle outline on the canvas
  function drawRect(x1, y1, x2, y2, color, size) {
    ctx.strokeStyle = color;
    ctx.lineWidth = size;
    let left = Math.min(x1, x2);
    let top = Math.min(y1, y2);
    let width = Math.abs(x2 - x1);
    let height = Math.abs(y2 - y1);
    ctx.strokeRect(left, top, width, height); // Draws an outline
  }

  // Function to draw a circle outline on the canvas
  function drawCircle(x1, y1, x2, y2, color, size) {
    ctx.strokeStyle = color;
    ctx.lineWidth = size;
    let centerX = (x1 + x2) / 2;
    let centerY = (y1 + y2) / 2;
    let radius = Math.hypot(x2 - x1, y2 - y1) / 2;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.stroke(); // Draws an outline
  }

  // Function to draw a pentagon outline on the canvas
  function drawPentagon(x1, y1, x2, y2, color, size) {
    ctx.strokeStyle = color;
    ctx.lineWidth = size;
    let centerX = (x1 + x2) / 2;
    let centerY = (y1 + y2) / 2;
    let radius = Math.hypot(x2 - x1, y2 - y1) / 2;
    let sides = 5;
    ctx.beginPath();
    for(let i=0; i<sides; i++){
      let angle = (Math.PI * 2 / sides) * i - Math.PI / 2;
      let x = centerX + radius * Math.cos(angle);
      let y = centerY + radius * Math.sin(angle);
      if(i === 0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.stroke(); // Draws an outline
  }

  function updateCursor(e) {
    const rect = board.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if(tool === 'pen') {
      penCursor.style.left = x + 'px'; // Position top-left at cursor
      penCursor.style.top = y + 'px'; // Position top-left at cursor
      penCursor.style.display = 'block';
      eraserCursor.style.display = 'none';
      penCursor.className = 'fas fa-pencil-alt'; // Set the icon class for the pen cursor
      penCursor.style.color = penColor; // Set pen cursor color to current pen color
    } else {
      eraserCursor.style.width = eraserSize + 'px';
      eraserCursor.style.height = eraserSize + 'px';
      eraserCursor.style.left = (x - eraserSize / 2) + 'px';
      eraserCursor.style.top = (y - eraserSize / 2) + 'px';
      eraserCursor.style.display = 'block';
      penCursor.style.display = 'none';
    }
  }

  function startDraw(e) {
    drawing = true;
    const rect = board.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    lastX = startX;
    lastY = startY;

    if(tool === 'pen' && shape === 'freehand') {
      ctx.strokeStyle = penColor;
      ctx.lineWidth = penSize;
      ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(startX, startY);
    }
  }

  function draw(e) {
    if(!drawing) return;

    const rect = board.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if(tool === 'pen') {
      if(shape === 'freehand') {
        ctx.lineTo(x, y);
        ctx.stroke();
      } else {
        overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
        switch(shape) {
          case 'line':
            overlayCtx.strokeStyle = penColor;
            overlayCtx.lineWidth = penSize;
            overlayCtx.beginPath();
            overlayCtx.moveTo(startX, startY);
            overlayCtx.lineTo(x, y);
            overlayCtx.stroke();
            break;
          case 'rect':
            overlayCtx.strokeStyle = penColor;
            overlayCtx.lineWidth = penSize;
            let left = Math.min(startX, x);
            let top = Math.min(startY, y);
            let width = Math.abs(x - startX);
            let height = Math.abs(y - startY);
            overlayCtx.strokeRect(left, top, width, height);
            break;
          case 'circle':
            overlayCtx.strokeStyle = penColor;
            overlayCtx.lineWidth = penSize;
            let centerX = (startX + x) / 2;
            let centerY = (startY + y) / 2;
            let radius = Math.hypot(x - startX, y - startY) / 2;
            overlayCtx.beginPath();
            overlayCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            overlayCtx.stroke();
            break;
          case 'pentagon':
            overlayCtx.strokeStyle = penColor;
            overlayCtx.lineWidth = penSize;
            let cx = (startX + x) / 2;
            let cy = (startY + y) / 2;
            let r = Math.hypot(x - startX, y - startY) / 2;
            let sides = 5;
            overlayCtx.beginPath();
            for(let i=0; i<sides; i++){
              let angle = (Math.PI * 2 / sides) * i - Math.PI / 2;
              let px = cx + r * Math.cos(angle);
              let py = cy + r * Math.sin(angle);
              if(i === 0) overlayCtx.moveTo(px, py);
              else overlayCtx.lineTo(px, py);
            }
            overlayCtx.closePath();
            overlayCtx.stroke();
            break;
        }
      }
    } else if(tool === 'eraser') {
      ctx.clearRect(x - eraserSize/2, y - eraserSize/2, eraserSize, eraserSize);
    }

    lastX = x;
    lastY = y;
  }

  function endDraw(e) {
    if(!drawing) return;
    drawing = false;
    const rect = board.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if(tool === 'pen' && shape !== 'freehand') {
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
      // draw final shape on main canvas
      switch(shape) {
        case 'line': drawLine(startX, startY, x, y, penColor, penSize); break;
        case 'rect': drawRect(startX, startY, x, y, penColor, penSize); break;
        case 'circle': drawCircle(startX, startY, x, y, penColor, penSize); break;
        case 'pentagon': drawPentagon(startX, startY, x, y, penColor, penSize); break;
      }
    }
    pushHistory();
  }

  // Event listeners
  board.addEventListener('pointerdown', e => { startDraw(e); updateCursor(e); });
  board.addEventListener('pointermove', e => { draw(e); updateCursor(e); });
  board.addEventListener('pointerup', e => { endDraw(e); });
  board.addEventListener('pointerleave', e => { endDraw(e); });

  // Cursor update on move also outside drawing (for eraser/pen)
  window.addEventListener('pointermove', updateCursor);

  // Controls
  toggleBtn.addEventListener('click', () => {
    if(controls.style.display === 'flex') controls.style.display = 'none';
    else controls.style.display = 'flex';
  });

  // Tool selection (Pen/Eraser)
  document.querySelectorAll('button.tool').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('button.tool').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      tool = btn.dataset.tool;

      // Update pen tool icon color based on selection
      if (tool === 'pen') {
        controlPenIcon.style.color = penColor;
        // Also update the active shape's icon color
        const currentActiveShapeItem = document.querySelector(`.shape-dropdown-item.active`);
        if (currentActiveShapeItem) {
            currentActiveShapeItem.style.color = penColor;
        }
      } else {
        controlPenIcon.style.color = '#ffffff'; // Revert pen icon to white if eraser is selected
        // Revert all shape icons to white when eraser is selected
        shapeDropdownItems.forEach(item => {
            item.style.color = '#ffffff';
        });
      }


      if(tool === 'eraser') {
        shape = 'freehand'; // Eraser always freehand
        shapeDropdownTrigger.classList.remove('active'); // Deactivate trigger button
        document.querySelectorAll('.shape-dropdown-item').forEach(b => b.classList.remove('active')); // Deactivate shape buttons
        shapeDropdownMenu.classList.remove('open'); // Close dropdown if open
        shapeDropdownTrigger.style.display = 'none'; // Hide shape selection trigger
      } else {
        shapeDropdownTrigger.style.display = 'flex'; // Show shape selection trigger
        // Reactivate the current shape button
        shapeDropdownTrigger.classList.add('active');
        document.querySelector(`.shape-dropdown-item[data-shape="${shape}"]`).classList.add('active');
      }
    });
  });

  // Shape selector dropdown functionality
  shapeDropdownTrigger.addEventListener('click', (e) => {
    e.stopPropagation(); // Prevent click from bubbling to document and closing immediately
    shapeDropdownMenu.classList.toggle('open');
  });

  shapeDropdownItems.forEach(item => {
    item.addEventListener('click', () => {
      // Revert previously active shape's icon to white
      const prevActiveShapeItem = document.querySelector('.shape-dropdown-item.active');
      if (prevActiveShapeItem) {
          prevActiveShapeItem.style.color = '#ffffff';
      }

      shapeDropdownItems.forEach(b => b.classList.remove('active'));
      item.classList.add('active');
      shape = item.dataset.shape;
      // Set newly active shape's icon color to penColor
      item.style.color = penColor;

      // Update the trigger button's icon to match the selected shape and its color
      shapeDropdownTrigger.querySelector('i').className = item.querySelector('i').className;
      shapeDropdownTrigger.style.color = penColor; // Keep trigger icon color in sync
      shapeDropdownMenu.classList.remove('open'); // Close dropdown
    });
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!shapeDropdownMenu.contains(e.target) && !shapeDropdownTrigger.contains(e.target)) {
      shapeDropdownMenu.classList.remove('open');
    }
  });


  document.getElementById('penColor').addEventListener('change', e => {
    penColor = e.target.value;
    // Update pen cursor color immediately when color changes
    if (tool === 'pen') {
      penCursor.style.color = penColor;
      controlPenIcon.style.color = penColor; // Update control pen icon color
      // Update active shape icon color
      const currentActiveShapeItem = document.querySelector(`.shape-dropdown-item.active`);
      if (currentActiveShapeItem) {
          currentActiveShapeItem.style.color = penColor;
      }
    }
  });

  document.getElementById('bgColorPicker').addEventListener('change', e => {
    bgColor = e.target.value;
    board.style.backgroundColor = bgColor;
  });

  document.getElementById('penSize').addEventListener('input', e => {
    penSize = e.target.value;
  });

  document.getElementById('eraserSize').addEventListener('input', e => {
    eraserSize = e.target.value;
  });

  document.getElementById('undoBtn').addEventListener('click', undo);
  document.getElementById('clearBtn').addEventListener('click', () => {
    clearAll();
  });

  // Initialize defaults
  board.style.backgroundColor = bgColor;
  pushHistory();

  // Initial color setup for controls and shapes
  controlPenIcon.style.color = penColor; // Set initial pen icon color
  shapeDropdownItems.forEach(item => {
      if (item.dataset.shape === shape) { // If it's the default active shape
          item.style.color = penColor;
          shapeDropdownTrigger.style.color = penColor; // Also set trigger color
      } else {
          item.style.color = '#ffffff'; // All others white
      }
  });


})();
</script>
</body>
</html>
